# Sogo Auth Bot 세부명세서 - 이메일 인증 기능
## 세부 명세 | Function Details
### 인증 대상 유저 및 인증 대상 유저 조건
이메일 인증을 하려면 `인증 대상 유저`가 다음 조건을 갖추어야 한다.

> **인증 대상 유저 조건**
> 1. 서버에 처음 접속한 유저 or
> 2. 동기화 주기마다, DB에 discord id가 등록되지 않은 유저

 JDA 의 EventListener 와 Timer 를 통해 `인증 대상 유저`가 존재하는지 조건에 맞게 검사한다.
 
인증대상 유저가 존재할 경우, 아래의 `본인 인증 로직` 을 수행한다.

### 본인인증 로직
본인인증로직은 다음과 같은 단계를 거친다.
1. `인증 대상 유저` 에게 `본인인증 요청` 을 전송한다
2. 유저가 `본인인증 시작 요청` 을 보낼경우 `이메일 입력란` 을 전송한다.
3. 유저가 `이메일 입력란` 에 이메일을 입력시, `메일 검사 로직` 을 수행한다

4. `메일 검사 로직` 의 성공여부에따라 다음과 같은 작업을 수행한다.
    
    해당 작업들은 따로 메서드로 분리해서 `메일 검사 로직` 에서 호출할 수 있도록 한다. (callback 구현을 위함)

    1. `메일 검사 로직` 이 성공적으로 끝나면,
       
        해당 유저의 정보를 Database 에 저장하고 
       
        `인증 성공 응답`을 전송한 뒤,
       
        `본인인증 로직` 을 종료한다
    2. `메일 검사 로직` 이 실패할 경우, 
       
        `인증 실패 응답` 을 전송한다.
> **인증 대상 유저**
> - 디스코드 이름
> - 디스코드 유저 id

> **본인인증 요청**
> - 환영메세지 (선택)
> - 본인인증 설명
> - 본인인증 방법

> **본인인증 시작 요청**
> 
> 디스코드 유저 id
> 
> = command

> **이메일 입력란**
> - 이메일 입력 유도 메세지
> - 이메일 입력란 혹은 이를 대체할 수 있는 기능

> **인증 성공 응답**
> - 제목
> - 세부 설명

> **인증 실패 응답**
> - 제목
> - 실패 사유
> - 해결 방법 or 문서 (선택)

### 메일 검사 로직
메일 검사 로직은 다음과 같은 단계를 거친다.

_`메일 입력란` 을 통해 구한 유저의 이메일 을 `유저 이메일` 이라 칭한다_

1. `유저 이메일` 의 도메인을 학교의 도메인과 대조해, 학교정보를 구한다
    
    만약, 학교 도메인이 아닐경우, 검사에 실패하며, `본인인증 로직` 의 4-ii 로직을 구현한 메서드를 호출한다.
2. JMS 를 통해 `유저 이메일` 에 `인증 링크`를 전송한다
3. 유저가 `인증링크`에 접속할경우, 해당 링크의 token 을 통해 유저를 식별하여, 
   `본인인증 로직` 의 4-i 로직을 구현한 메서드를 호출한다.
   
> **인증링크**
> - 기본 링크주소
> - jwt 를 통한 유저 식별 
>    
>    인증 대상 유저를 json 으로 치환하여 payload 에 담는다

## 서비스 진행 시뮬레이션 | Sequence DIagram
- `본인인증 요청` 전송 (bot to `인증 대상 유저`)
- `본인인증 시작 요청` 전송 (`인증 대상 유저` to bot)
- `이메일 입력란` 전송 (bot to `인증 대상 유저`)
- `유저 이메일` 전송 (`인증 대상 유저` to bot)
- `인증링크` 전송 (bot to `유저 이메일`, query_string `jwt token`)
- `인증링크` 접속 (is `인증 대상 유저`, query_string `jwt token`)
- `인증링크` 의 `jwt token` 의 토큰 유효성 검사 및 `payload`를 통한 `인증대상 유저` 식별 및
    - `인증대상 유저` 식별시
        - 토큰 유효성 검사 실패시
        
            `인증 실패 응답` 전송 (bot to `인증 대상 유저`)
        - 토큰 유효성 검사 성공시
    
            db 에 `인증대상 유저` 정보 저장
            `인증 성공 응답` 전송 (bot to `인증 대상 유저`)
